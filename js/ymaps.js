ymaps.ready(init);






function init() {
	
	// var data = JSON.parse(document.getElementById('map-points').innerHTML);
	// console.log(data)
	// Контейнер для меню.
	let searchpanel = $(`<input class="search_panel" placeholder="Поиск">`);
	var menu = $('<div class="city_cont"/>');
	let module_map = $('.ymaps-2-1-78-map');

	console.log(searchpanel[0]);
	searchpanel[0].addEventListener('input',(e) => {
	  console.log(e.target.value)
	  let searchresult = e.target.value;
	  let result = Object.fromEntries(Object
		  .entries(data)
		  .map(n => [ n[0], n[1].filter(m => m.title.toLowerCase().includes(searchresult.toLowerCase())) ])
		  .filter(n => n[1].length)
		);
	  console.log(result);
	  
	  $('.ymaps-2-1-78-map').remove();
	  getUl(result);
	  e.target.focus();
	});

	
	// Перебираем все группы.
	function getUl(datadiller) {
		var myMap = new ymaps.Map('map', {
				center: [53.313909, 49.962773],
				zoom: 6,
				controls: []
		});
		

		myMap.controls.add('zoomControl');
	//	myMap.behaviors.disable('scrollZoom');
		myMap.events.add('click', function () {
			myMap.balloon.close();
		});

		menu[0].innerHTML = '';
		$.each(datadiller, function (index, items) {
		// DOM-представление группы.
		var menuItem = $('<div class="city_title">' + index + '<span></span></div>'),
		// Создадим коллекцию для геообъектов группы.
		collection = new ymaps.GeoObjectCollection(null);
		// Добавляем коллекцию на карту.
		myMap.geoObjects.add(collection);

		menuItem
		// Добавляем пункт в меню.
		.appendTo(menu)
		// Навешиваем обработчик клика по пункту меню.
		.on('click', function (e) {
			// Скрываем/отображаем пункты меню данной группы.
			$(this)
			.toggleClass('active')
			.nextUntil('.city_title')
			.removeClass('active')
			.slideToggle('fast');

			// Скрываем/отображаем коллекцию на карте.
			if (collection.getParent()) {
				myMap.geoObjects.add(collection);
			} else {
				myMap.geoObjects.remove(collection);
			}
		});

		// Перебираем элементы группы.
		$.each(items, function (i, item) {

			var coord = [item.coordX, item.coordY];
			// DOM-представление элемента группы.
			
			var menuItem = $(`<div class="shop_cont" data-coord="${coord}"><div class="shop_title">${item.title}</div><div class="shop_phone"><a href="tel:${item.phone}">${item.phone}</a></div><div class="shop_address">${item.address}</div><a href="http://${item.site}" target="_blank" class="shop_site">${item.site}</a></div>`),
			// Создаем метку.	
			
			placemark = new ymaps.Placemark([item.coordX, item.coordY], {
					//				balloonContent: coord
					balloonContentHeader: '<div class="baloon_' + item.dealer + '"><strong>' + item.title + '</strong></div>',
					balloonContentBody: '<div><a href="geo:'+item.coordX+','+item.coordY+'">' + item.address + '</a></div>',
					balloonContentFooter: '<div><a href="tel:' + item.phone + '">' + item.phone + '</a></div>',
					hintContent: item.title		
				}, {
					preset: 'islands#redIcon',
					iconColor: '#' + item.color
				});

			if (item.equip == "true") {

				let equipicon = document.createElement('div');
				equipicon.className = 'equip';
				equipicon.innerHTML = `<svg width="3rem" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="22" height="22" fill="transparent"/>
				<path d="M11.3789 14.8337L10.8334 14.6346L8.74547 10.5068C8.72606 10.4683 8.69447 10.4375 8.65565 10.4189L4.55657 8.45878C4.85174 7.56952 5.37851 6.80284 6.08741 6.23403C6.17135 6.16669 6.18481 6.04403 6.11744 5.96011C6.0501 5.87617 5.92744 5.86276 5.84352 5.93008C5.03067 6.58231 4.43918 7.4731 4.13305 8.5062C4.12517 8.53272 4.12304 8.56065 4.12681 8.58804L4.50094 11.3137C4.50512 11.3442 4.51648 11.3733 4.53404 11.3985L4.92677 11.9631V12.757C4.92677 12.8388 4.97793 12.912 5.05481 12.94L11.2452 15.1998C11.2673 15.2079 11.2898 15.2117 11.312 15.2117C11.3916 15.2117 11.4662 15.1626 11.4951 15.0836C11.532 14.9825 11.48 14.8706 11.3789 14.8337ZM10.2978 14.4391L9.1805 14.0312L7.98559 12.2399C7.96174 12.2042 7.92675 12.1773 7.88603 12.1635L4.8707 11.1415L4.80383 10.6542L5.07266 10.7959C5.10163 10.8111 5.13273 10.8184 5.16331 10.8184C5.2333 10.8184 5.30098 10.7805 5.3359 10.7143C5.38607 10.6191 5.34951 10.5012 5.25432 10.451L4.73864 10.1794L4.67642 9.72602L5.07268 9.93475C5.10165 9.95 5.13273 9.95725 5.16331 9.95725C5.23332 9.95725 5.30101 9.91939 5.3359 9.85314C5.38607 9.75795 5.34951 9.6401 5.25429 9.58993L4.61123 9.25121L4.56213 8.89342L8.42767 10.7418L10.2978 14.4391ZM5.28162 11.7907L5.19207 11.6619L7.69819 12.5113L8.56126 13.8052L5.31652 12.6207V11.9019C5.31652 11.8622 5.30436 11.8233 5.28162 11.7907Z" fill="#F05A28"/>
				<path d="M17.286 6.87946C17.286 6.87946 11.371 5.17151 11.3661 5.1705C10.6833 4.93308 9.91304 4.8125 9.07585 4.8125C8.21673 4.8125 7.37268 5.01892 6.63499 5.40947C6.53987 5.45982 6.50358 5.57778 6.55393 5.67287C6.58893 5.73894 6.65645 5.77661 6.72634 5.77661C6.75708 5.77661 6.78828 5.76931 6.81733 5.75393C7.49908 5.393 8.28007 5.20224 9.07588 5.20224C9.85794 5.20224 10.5755 5.3124 11.2102 5.52911L12.0428 6.61653C12.1056 6.69856 12.1263 6.80287 12.0995 6.90269C12.0727 7.00251 12.0026 7.08245 11.9072 7.12205L11.4621 7.30659C11.4133 7.32678 11.3749 7.36588 11.3555 7.41496C11.3361 7.46401 11.3374 7.51883 11.3592 7.5669L11.7707 8.47658C11.0115 8.78332 10.4988 9.52742 10.4988 10.3607V11.019C10.4988 11.7839 10.9213 12.4763 11.6015 12.8261L13.8465 13.9807L13.1755 15.49L12.2333 15.146C12.1321 15.109 12.0204 15.1612 11.9835 15.2622C11.9465 15.3633 11.9986 15.4752 12.0997 15.5121L14.7735 16.4882C14.7955 16.4962 14.818 16.5 14.8403 16.5C14.91 16.5 14.9767 16.4624 15.0116 16.398L15.8516 14.8495C15.8663 14.8224 15.8743 14.7923 15.8751 14.7615L15.9247 12.7887C15.9262 12.7299 15.901 12.6735 15.8562 12.6354L14.9666 11.8786C14.9225 11.8411 14.864 11.8251 14.8069 11.835C14.7499 11.8449 14.7002 11.8797 14.6714 11.9299L14.1605 12.8186L13.3561 12.4049C13.2604 12.3557 13.1429 12.3934 13.0937 12.4891C13.0445 12.5848 13.0822 12.7022 13.1779 12.7515L14.1476 13.2502C14.2402 13.2978 14.3538 13.2642 14.4057 13.174L14.8925 12.3272L15.2005 12.5893L14.6255 13.5893C14.5375 13.7424 14.3456 13.7991 14.1884 13.7183L11.7797 12.4795C11.23 12.1967 10.8885 11.6371 10.8885 11.019V10.3607C10.8885 9.62313 11.3826 8.96986 12.0939 8.77482L14.1134 8.21521C14.1694 8.33675 14.2228 8.46263 14.273 8.59228L12.2016 9.16035C11.6625 9.30814 11.2861 9.80165 11.2861 10.3605V11.0189C11.2861 11.4872 11.5449 11.9114 11.9616 12.1259L12.3657 12.3338C12.3942 12.3484 12.4246 12.3554 12.4547 12.3554C12.5254 12.3553 12.5936 12.3168 12.6281 12.2496C12.6773 12.1539 12.6396 12.0364 12.5439 11.9872L12.1399 11.7794C11.8536 11.632 11.6758 11.3406 11.6758 11.0189V10.3605C11.6758 9.97666 11.9344 9.63771 12.3046 9.5362L14.5811 8.9119C14.6333 8.89755 14.6772 8.86219 14.7023 8.81423C14.7273 8.76625 14.7313 8.71002 14.7133 8.659C14.6551 8.49451 14.5921 8.33433 14.5249 8.18003H17.2319C17.3395 8.18003 17.4267 8.09281 17.4267 7.98517V7.06666C17.4267 6.97985 17.3693 6.90355 17.286 6.87946V6.87946ZM14.9634 13.7835L15.5024 12.8461L15.5328 12.8719L15.4931 14.4514L15.2686 14.3444C15.1715 14.2982 15.0552 14.3393 15.0088 14.4364C14.9626 14.5336 15.0038 14.6499 15.1009 14.6962L15.4111 14.8441L15.1829 15.2649L14.8487 15.1056C14.7516 15.0592 14.6353 15.1004 14.589 15.1976C14.5426 15.2947 14.5838 15.411 14.681 15.4573L14.9968 15.6079L14.7492 16.0644L13.5425 15.6238L14.2057 14.1321C14.2502 14.1405 14.295 14.1449 14.3395 14.1449C14.5891 14.1449 14.8305 14.0146 14.9634 13.7835V13.7835ZM17.037 7.79036H14.2137C14.1961 7.79036 14.1786 7.79275 14.1616 7.79743L12.1441 8.35652L11.7971 7.58953L12.0564 7.48202C12.2646 7.39571 12.4175 7.22132 12.4759 7.00365C12.5343 6.78598 12.4892 6.55852 12.3522 6.37958L11.8412 5.71215L17.037 7.21317V7.79036Z" fill="#F05A28"/>
				</svg>
				`;
				let title = menuItem[0].querySelector('.shop_title');
				title.append(equipicon);
				
				// console.log('Есть экипировка')
			}
			if (item.snow_zip == "true") {

				let snowicon = document.createElement('div');
				snowicon.className = 'equip';
				snowicon.innerHTML = `<svg width="3rem" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="22" height="22" fill="transparent"/>
				<g clip-path="url(#clip0)">
				<path d="M6.34313 12.5474C5.91215 12.5474 5.56152 12.898 5.56152 13.329C5.56152 13.76 5.91215 14.1106 6.34313 14.1106C6.77411 14.1106 7.12474 13.76 7.12474 13.329C7.12474 12.898 6.77411 12.5474 6.34313 12.5474ZM6.34313 13.6473C6.16762 13.6473 6.02481 13.5045 6.02481 13.329C6.02481 13.1534 6.16759 13.0107 6.34313 13.0107C6.51867 13.0107 6.66145 13.1534 6.66145 13.329C6.66145 13.5045 6.51867 13.6473 6.34313 13.6473Z" fill="#F05A28"/>
				<path d="M8.53161 12.5474C8.10062 12.5474 7.75 12.898 7.75 13.329C7.75 13.76 8.10062 14.1106 8.53161 14.1106C8.96259 14.1106 9.31321 13.7599 9.31321 13.329C9.31321 12.898 8.96259 12.5474 8.53161 12.5474ZM8.53161 13.6473C8.35609 13.6473 8.21329 13.5045 8.21329 13.329C8.21329 13.1534 8.35606 13.0107 8.53161 13.0107C8.70715 13.0107 8.84993 13.1535 8.84993 13.329C8.84993 13.5045 8.70712 13.6473 8.53161 13.6473Z" fill="#F05A28"/>
				<path d="M10.7201 12.5474C10.2891 12.5474 9.93848 12.898 9.93848 13.329C9.93848 13.76 10.2891 14.1106 10.7201 14.1106C11.1511 14.1106 11.5017 13.7599 11.5017 13.329C11.5017 12.898 11.1511 12.5474 10.7201 12.5474ZM10.7201 13.6473C10.5446 13.6473 10.4018 13.5045 10.4018 13.329C10.4018 13.1534 10.5446 13.0107 10.7201 13.0107C10.8957 13.0107 11.0384 13.1535 11.0384 13.329C11.0384 13.5045 10.8956 13.6473 10.7201 13.6473Z" fill="#F05A28"/>
				<path d="M19.7209 12.3158C19.4353 12.0347 18.9742 12.0383 18.6931 12.3239C18.1407 12.885 17.3722 13.2069 16.5848 13.2069H16.3037L15.691 11.9337C16.7866 11.4829 17.5763 10.8193 17.9843 10.002C18.0292 9.91206 18.0096 9.80001 17.9368 9.73068C17.9367 9.73061 17.9367 9.73055 17.9366 9.73052C17.3186 9.14339 16.4605 8.23142 14.8152 7.63737C14.6949 7.59395 14.5621 7.65624 14.5186 7.77657C14.4752 7.89689 14.5375 8.02969 14.6578 8.07311C15.6885 8.4452 16.4693 8.97554 17.1969 9.66678H11.3915L10.8353 8.85534L11.8421 7.83228C11.9534 7.71915 12.1083 7.6543 12.267 7.6543C12.7272 7.6543 13.1906 7.70016 13.6442 7.79065C13.7697 7.81582 13.8917 7.73426 13.9167 7.60881C13.9417 7.48332 13.8603 7.36133 13.7348 7.33632C13.2514 7.2399 12.7575 7.19101 12.267 7.19101C11.9849 7.19101 11.7097 7.3063 11.5118 7.50735L11.1435 7.88163L10.7536 7.53212L11.232 7.04598C11.3217 6.95478 11.3206 6.80811 11.2294 6.71839C11.1382 6.62868 10.9915 6.62982 10.9018 6.72102L9.60456 8.03926C9.51484 8.13046 9.51601 8.27713 9.60718 8.36685C9.69841 8.45663 9.84511 8.45533 9.93477 8.36422L10.4283 7.86273L10.8182 8.21224L10.3725 8.66515L9.81 9.21875C9.7957 9.23283 9.77676 9.24058 9.75669 9.24058H7.13568L7.00386 9.02087C6.90575 8.85738 6.72631 8.75577 6.53563 8.75577H4.50518C4.29554 8.75574 4.125 8.92628 4.125 9.13595V9.87478C4.125 9.98201 4.15289 10.088 4.2057 10.1814L5.23901 12.0079C4.70867 12.0807 4.29872 12.5366 4.29872 13.0867V13.5713C4.29872 14.1719 4.78733 14.6605 5.38799 14.6605H7.99082C8.11874 14.6605 8.22248 14.5568 8.22248 14.4289C8.22248 14.3009 8.11877 14.1972 7.99082 14.1972H5.38799C5.04284 14.1972 4.76201 13.9164 4.76201 13.5712V13.0866C4.76201 12.7415 5.04284 12.4607 5.38799 12.4607H11.6746C12.0198 12.4607 12.3006 12.7415 12.3006 13.0866V13.5712C12.3006 13.9164 12.0198 14.1972 11.6746 14.1972H9.07181C8.94389 14.1972 8.84015 14.3009 8.84015 14.4289C8.84015 14.5568 8.94386 14.6605 9.07181 14.6605H11.6746C12.2753 14.6605 12.7639 14.1719 12.7639 13.5713V13.0867C12.7639 12.8538 12.6902 12.638 12.5653 12.4607H13.6261C13.6333 12.4607 13.6404 12.4604 13.6475 12.4597C13.679 12.4568 14.3909 12.3881 15.2552 12.0965L15.7896 13.2069H14.4178C14.017 13.2069 13.691 13.533 13.691 13.9337C13.691 14.3345 14.0171 14.6606 14.4178 14.6606H16.5848C17.7591 14.6606 18.9051 14.1806 19.729 13.3437C20.0101 13.0581 20.0065 12.597 19.7209 12.3158ZM9.75666 9.70384V9.70381C9.8991 9.70381 10.0334 9.6488 10.135 9.54889L10.5016 9.18805L10.9449 9.83466L9.93319 10.4996C9.89647 10.5237 9.84888 10.5384 9.80366 10.5384H8.00854C7.94897 10.5384 7.89471 10.5055 7.86605 10.4577L7.41372 9.70387H9.75666V9.70384ZM13.6143 11.9974C13.0043 11.9974 5.98346 11.9974 5.76539 11.9974L4.60895 9.95323C4.59542 9.92935 4.58832 9.90224 4.58832 9.87478V9.21902H6.53563C6.56454 9.21902 6.59172 9.23444 6.60661 9.2592L6.95939 9.84714L7.46876 10.696C7.58154 10.884 7.78806 11.0016 8.00854 11.0016H9.80366C9.94412 11.0016 10.0784 10.9585 10.1877 10.8867L11.3388 10.1302H17.3712C16.2961 11.682 13.7902 11.9785 13.6143 11.9974ZM19.3989 13.0187C18.6616 13.7677 17.6359 14.1972 16.5849 14.1972H14.4179C14.2726 14.1972 14.1544 14.079 14.1544 13.9337C14.1544 13.7884 14.2725 13.6702 14.4179 13.6702C14.6301 13.6702 16.3737 13.6702 16.5849 13.6702C17.4955 13.6702 18.3844 13.2979 19.0233 12.6489C19.1252 12.5453 19.2924 12.544 19.396 12.6459C19.4994 12.7479 19.5008 12.9151 19.3989 13.0187Z" fill="#F05A28"/>
				</g>
				<defs>
				<clipPath id="clip0">
				<rect width="15.8125" height="15.8125" fill="white" transform="translate(4.125 2.75)"/>
				</clipPath>
				</defs>
				</svg>

				`;
				let title = menuItem[0].querySelector('.shop_title');
				title.append(snowicon);
			}
			if (item.water_zip == "true") {

				let watericon = document.createElement('div');
				watericon.className = 'equip';
				watericon.innerHTML = `<svg width="3rem" viewBox="0 0 22 22" fill="none" xmlns="http://www.w3.org/2000/svg">
				<rect width="22" height="22" fill="transparent"/>
				<g clip-path="url(#clip0)">
				<path d="M19.5185 9.60059L3.15918 11.7148L4.58039 14.1839H12.4124C15.49 14.1839 18.2762 12.3942 19.5185 9.60059Z" stroke="#F05A28" stroke-width="0.6" stroke-miterlimit="10" stroke-linecap="round"/>
				<path d="M5.73145 11.4299L6.79991 8.96589L12.4899 7.90625L14.9796 10.2435" stroke="#F05A28" stroke-width="0.6" stroke-miterlimit="10" stroke-linecap="round"/>
				</g>
				<defs>
				<clipPath id="clip0">
				<rect width="17.1875" height="6.875" fill="white" transform="translate(2.75 7.5625)"/>
				</clipPath>
				</defs>
				</svg>
				`;
				let title = menuItem[0].querySelector('.shop_title');
				title.append(watericon);
			}
			// Добавляем метку в коллекцию.
			collection.add(placemark);

			menuItem.appendTo(menu)
			// Добавляем пункт в меню.

			// Навешиваем обработчик клика по пункту меню.
			.on('click', function (e) {
				// Отменяем основное поведение (переход по ссылке)
//				e.preventDefault();

				// Выставляем/убираем класс active.
				menuItem
				.toggleClass('active')
				.siblings('.shop_cont.active')
				.removeClass('active');

				// Получаем координаты placemark.
				var coords = placemark.geometry.getCoordinates();
				// Плавно перелетаем по координатам.
				myMap.panTo([coords], {
					delay: 0
				}).then(function () {
					// Увеличиваем масштаб на объекте.
					myMap.setZoom(16);
					// Открываем/закрываем баллун у метки.
					if(placemark.balloon.isOpen()) {
						placemark.balloon.close();
					} else {
						placemark.balloon.open();
					}
				});
			});
		});
	});

	// Добавляем меню в сайдбар.
	searchpanel.prependTo($('#dealers_list'));
	menu.appendTo($('#dealers_list .list'));
	}
	
	// Выставляем масштаб карты чтобы были видны все группы.
	//	myMap.setBounds(myMap.geoObjects.getBounds());
	getUl(data);
}
